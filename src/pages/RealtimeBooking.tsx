import React, { useState, useEffect, useRef } from 'react';
import './RealtimeBooking.css';
import { 
  getRooms, 
  getSeasons, 
  getHolidays, 
  getPrices, 
  getReservations,
  addReservation,
  checkDataExists,
  migrateDataToFirebase,
  resetFirebaseData
} from '../firebase/services';

// ... Í∏∞Ï°¥ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Îì§ ÎèôÏùº ...
interface Room {
  id: string;
  originalId?: number;
  name: string;
  name_eng: string;
  area: number;
  capacity: number;
  min: number;
  desc: string;
  desc_eng: string;
  images: any[];
}

interface Season {
  id: string;
  originalId?: number;
  name: string;
  start_date: string;
  end_date: string;
}

interface Holiday {
  id: string;
  originalId?: number;
  holiday_name: string;
  holiday_date: string;
}

interface Price {
  id: string;
  originalId?: number;
  room_id: number;
  season_id: number;
  weekday_price: number;
  weekend_price: number;
  holiday_price: number;
}

interface Reservation {
  id: string;
  customer_name: string;
  phone_number: string;
  room_id: number;
  check_in_date: string;
  check_out_date: string;
  number_of_guests: number;
  total_price: number;
}

interface BookingForm {
  additionalGuests: number;
  guestName: string;
  phoneNumber: string;
}

const RealtimeBooking: React.FC = () => {
  const [rooms, setRooms] = useState<Room[]>([]);
  const [seasons, setSeasons] = useState<Season[]>([]);
  const [holidays, setHolidays] = useState<Holiday[]>([]);
  const [prices, setPrices] = useState<Price[]>([]);
  const [reservations, setReservations] = useState<Reservation[]>([]);
  const [loading, setLoading] = useState(true);
  const [step, setStep] = useState(1);
  const [selectedRoom, setSelectedRoom] = useState<Room | null>(null);
  const [selectedDates, setSelectedDates] = useState<{
    checkIn: Date | null;
    checkOut: Date | null;
  }>({ checkIn: null, checkOut: null });
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [bookingForm, setBookingForm] = useState<BookingForm>({
    additionalGuests: 0,
    guestName: '',
    phoneNumber: ''
  });
  const [selectingCheckOut, setSelectingCheckOut] = useState(false);
  const [showWarningModal, setShowWarningModal] = useState(false);
  const [showCompleteModal, setShowCompleteModal] = useState(false);
  const [showResetModal, setShowResetModal] = useState(false);

  // Ï§ëÎ≥µ Î°úÎî© Î∞©ÏßÄÎ•º ÏúÑÌïú ref
  const hasFetched = useRef(false);

  // KST Í∏∞Ï§Ä ÌòÑÏû¨ ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
  const getKSTDate = (): Date => {
    const now = new Date();
    const kstOffset = 9 * 60; // KSTÎäî UTC+9
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const kst = new Date(utc + (kstOffset * 60000));
    kst.setHours(0, 0, 0, 0); // ÏãúÍ∞Ñ Î∂ÄÎ∂Ñ Ï†úÍ±∞
    return kst;
  };

  // KST ÎÇ†ÏßúÎ•º YYYY-MM-DD ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò (ÏÇ¨Ïö©Ïûê ÌôîÎ©¥Ïö©)
  const formatKSTDate = (date: Date): string => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // KST ÎÇ†ÏßúÎ•º UTC ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò (ÏÑúÎ≤Ñ Ï†ÄÏû•Ïö©)
  const formatDateForServer = (kstDate: Date): string => {
    // KST ÎÇ†ÏßúÎ•º UTCÎ°ú Î≥ÄÌôò
    const utcDate = new Date(kstDate.getTime() - (9 * 60 * 60 * 1000));
    return utcDate.toISOString().split('T')[0];
  };

  // UTC ÎÇ†Ïßú Î¨∏ÏûêÏó¥ÏùÑ KST Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò (ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÏùΩÍ∏∞Ïö©)
  const parseUTCToKST = (utcDateString: string): Date => {
    const utcDate = new Date(utcDateString + 'T00:00:00Z');
    const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));
    return kstDate;
  };

  // KST ÎÇ†Ïßú Î¨∏ÏûêÏó¥ÏùÑ KST Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò (Î°úÏª¨ Ï≤òÎ¶¨Ïö©)
  const parseKSTDate = (dateString: string): Date => {
    const [year, month, day] = dateString.split('-').map(Number);
    return new Date(year, month - 1, day);
  };

  // Í∞ùÏã§Î≥Ñ Ïù¥ÎØ∏ÏßÄ URLÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò
  const getRoomImageUrl = (room: Room): string => {
    const roomNameLower = room.name_eng.toLowerCase();
    
    if (roomNameLower.includes('standard')) {
      return 'https://images.unsplash.com/photo-1590490360182-c33d57733427?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80';
    } else if (roomNameLower.includes('deluxe')) {
      return 'https://images.unsplash.com/photo-1611892440504-42a792e24d32?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80';
    } else if (roomNameLower.includes('premium')) {
      return 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80';
    } else if (roomNameLower.includes('suite')) {
      return 'https://images.unsplash.com/photo-1631049307264-da0ec9d70304?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80';
    }
    
    // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ (Ïä§ÌÉ†Îã§Îìú)
    return 'https://images.unsplash.com/photo-1590490360182-c33d57733427?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80';
  };

  // Firebase Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã Ìï∏Îì§Îü¨
  const handleDataReset = async () => {
    try {
      setLoading(true);
      console.log('üî• Firebase Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã ÏãúÏûë...');
      
      // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
      await resetFirebaseData();
      
      // ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
      await migrateDataToFirebase(true);
      
      // Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
      const [roomsData, seasonsData, holidaysData, pricesData, reservationsData] = await Promise.all([
        getRooms(),
        getSeasons(),
        getHolidays(),
        getPrices(),
        getReservations()
      ]);

      setRooms(roomsData);
      setSeasons(seasonsData);
      setHolidays(holidaysData);
      setPrices(pricesData);
      setReservations(reservationsData);
      
      setShowResetModal(false);
      alert('Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖãÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
      
    } catch (error) {
      console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã Ïã§Ìå®:', error);
      alert('Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖãÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    } finally {
      setLoading(false);
    }
  };

  // FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    // Ïù¥ÎØ∏ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôîÎã§Î©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
    if (hasFetched.current) {
      console.log('üîÑ Ï§ëÎ≥µ ÏöîÏ≤≠ Î∞©ÏßÄ: Ïù¥ÎØ∏ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.');
      return;
    }

    const fetchDataFromFirebase = async () => {
      try {
        hasFetched.current = true;
        setLoading(true);
        console.log('üî• RealtimeBooking: FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Îäî Ï§ë...');

        // Îç∞Ïù¥ÌÑ∞Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
        const dataCheck = await checkDataExists();
        console.log('üìä Îç∞Ïù¥ÌÑ∞ Ï≤¥ÌÅ¨ Í≤∞Í≥º:', dataCheck);

        // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò ÏûòÎ™ªÎêú Í≤ΩÏö∞ÏóêÎßå ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
        if (dataCheck.needsMigration) {
          console.log('üì¶ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏù¥ ÌïÑÏöîÌï©ÎãàÎã§...');
          
          // ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î¶¨ÏÖã Î™®Îã¨ ÌëúÏãú
          if (dataCheck.total > 0 && !dataCheck.isValid) {
            console.log('‚ö†Ô∏è ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä Í∞êÏßÄÎêòÏñ¥ Î¶¨ÏÖã Î™®Îã¨ÏùÑ ÌëúÏãúÌï©ÎãàÎã§.');
            setShowResetModal(true);
            setLoading(false);
            return;
          }
          
          // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏïÑÏòà ÏóÜÏúºÎ©¥ Î∞îÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
          if (dataCheck.total === 0) {
            await migrateDataToFirebase(false);
          }
        }

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const [roomsData, seasonsData, holidaysData, pricesData, reservationsData] = await Promise.all([
          getRooms(),
          getSeasons(),
          getHolidays(),
          getPrices(),
          getReservations()
        ]);

        console.log('‚úÖ RealtimeBooking Firebase Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å:');
        console.log('- Í∞ùÏã§:', roomsData.length);
        console.log('- ÏãúÏ¶å:', seasonsData.length);
        console.log('- Í≥µÌú¥Ïùº:', holidaysData.length);
        console.log('- Í∞ÄÍ≤©:', pricesData.length);
        console.log('- ÏòàÏïΩ:', reservationsData.length);

        setRooms(roomsData);
        setSeasons(seasonsData);
        setHolidays(holidaysData);
        setPrices(pricesData);
        setReservations(reservationsData);

      } catch (error) {
        console.error('‚ùå RealtimeBooking Firebase Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
        alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
        // ÏóêÎü¨ Î∞úÏÉùÏãú Ïû¨ÏãúÎèÑÎ•º ÏúÑÌï¥ ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
        hasFetched.current = false;
      } finally {
        setLoading(false);
      }
    };

    fetchDataFromFirebase();

    // cleanup Ìï®Ïàò
    return () => {
      console.log('üßπ RealtimeBooking Ïª¥Ìè¨ÎÑåÌä∏ cleanup');
    };
  }, []); // Îπà ÏùòÏ°¥ÏÑ± Î∞∞Ïó¥Î°ú ÎßàÏö¥Ìä∏ Ïãú Ìïú Î≤àÎßå Ïã§Ìñâ

  // Î£∏ ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ Í∞ÄÍ≤©ÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò
  const getBaseRoomPrice = (roomOriginalId: number): number => {
    const room = rooms.find(r => r.originalId === roomOriginalId);
    if (!room) return 150000;
    
    const roomNameLower = room.name_eng.toLowerCase();
    
    if (roomNameLower.includes('standard')) {
      return 150000;
    } else if (roomNameLower.includes('deluxe')) {
      return 180000;
    } else if (roomNameLower.includes('premium')) {
      return 200000;
    } else if (roomNameLower.includes('suite')) {
      return 250000;
    }
    
    return 150000; // Í∏∞Î≥∏Í∞í
  };

  // KST Í∏∞Ï§Ä ÎÇ†ÏßúÎ≥Ñ Í∞ÄÍ≤© Í≥ÑÏÇ∞ Ìï®Ïàò
  const calculateDatePrice = (kstDate: Date, roomOriginalId: number): number => {
    const dateStr = formatKSTDate(kstDate);
    
    // Í≥µÌú¥Ïùº Ï≤¥ÌÅ¨ (KST Í∏∞Ï§Ä)
    const isHoliday = holidays.some(holiday => holiday.holiday_date === dateStr);
    
    // Ï£ºÎßê Ï≤¥ÌÅ¨ (ÌÜ†ÏöîÏùº: 6, ÏùºÏöîÏùº: 0)
    const isWeekend = kstDate.getDay() === 0 || kstDate.getDay() === 6;
    
    // ÏãúÏ¶å Ï≤¥ÌÅ¨ (KST Í∏∞Ï§Ä)
    const currentSeason = seasons.find(season => {
      const startDate = parseKSTDate(season.start_date);
      const endDate = parseKSTDate(season.end_date);
      return kstDate >= startDate && kstDate <= endDate;
    });
    
    const seasonOriginalId = currentSeason ? currentSeason.originalId : 1; // Í∏∞Î≥∏Í∞íÏùÄ ÎπÑÏàòÍ∏∞
    
    // Ìï¥Îãπ Í∞ùÏã§Ïùò Í∞ÄÍ≤© Ï†ïÎ≥¥ Ï∞æÍ∏∞
    const priceInfo = prices.find(price => 
      price.room_id === roomOriginalId && price.season_id === seasonOriginalId
    );
    
    if (!priceInfo) return getBaseRoomPrice(roomOriginalId); // Î£∏ ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ Í∞ÄÍ≤©
    
    if (isHoliday) {
      return priceInfo.holiday_price;
    } else if (isWeekend) {
      return priceInfo.weekend_price;
    } else {
      return priceInfo.weekday_price;
    }
  };

  // KST Í∏∞Ï§Ä Ï¥ù Í∞ÄÍ≤© Í≥ÑÏÇ∞ (Í∏∞Ï§Ä 2Î™Ö + Ï∂îÍ∞Ä Ïù∏ÏõêÎ≥Ñ 20% Ï∂îÍ∞Ä)
  const calculateTotalPrice = (): number => {
    if (!selectedRoom || !selectedDates.checkIn || !selectedDates.checkOut) {
      return 0;
    }

    let total = 0;
    const current = new Date(selectedDates.checkIn);
    
    while (current < selectedDates.checkOut) {
      const basePrice = calculateDatePrice(current, selectedRoom.originalId || 1);
      const additionalPrice = basePrice * 0.2 * bookingForm.additionalGuests;
      total += basePrice + additionalPrice;
      current.setDate(current.getDate() + 1);
    }
    
    return total;
  };

  // KST Í∏∞Ï§ÄÏúºÎ°ú ÎÇ†ÏßúÍ∞Ä ÏòàÏïΩ Í∞ÄÎä•ÌïúÏßÄ Ï≤¥ÌÅ¨
  const isDateAvailable = (kstDate: Date): boolean => {
    if (!selectedRoom) return true;
    
    return !reservations.some(reservation => {
      if (reservation.room_id !== (selectedRoom.originalId || 1)) return false;
      
      // UTCÎ°ú Ï†ÄÏû•Îêú ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î•º KSTÎ°ú Î≥ÄÌôòÌïòÏó¨ ÎπÑÍµê
      const checkInDate = parseUTCToKST(reservation.check_in_date);
      const checkOutDate = parseUTCToKST(reservation.check_out_date);
      
      // Ï≤¥ÌÅ¨Ïù∏ ÎÇ†ÏßúÎ∂ÄÌÑ∞ Ï≤¥ÌÅ¨ÏïÑÏõÉ Ï†ÑÎÇ†ÍπåÏßÄÎßå ÏòàÏïΩ Î∂àÍ∞Ä
      return kstDate >= checkInDate && kstDate < checkOutDate;
    });
  };

  const handleRoomSelect = (room: Room) => {
    setSelectedRoom(room);
    setStep(2);
  };

  const getDaysInMonth = (date: Date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const days = [];
    const current = new Date(startDate);
    
    while (current <= lastDay || current.getDay() !== 0 || days.length < 42) {
      days.push(new Date(current));
      current.setDate(current.getDate() + 1);
      if (days.length >= 42) break;
    }
    
    return days;
  };

  const formatDate = (date: Date) => {
    return `${date.getFullYear()} ${String(date.getMonth() + 1).padStart(2, '0')}`;
  };

  const isSameDay = (date1: Date, date2: Date) => {
    return date1.getDate() === date2.getDate() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
  };

  const isDateInRange = (date: Date) => {
    if (!selectedDates.checkIn || !selectedDates.checkOut) return false;
    return date >= selectedDates.checkIn && date <= selectedDates.checkOut;
  };

  const handleDateClick = (date: Date) => {
    const today = getKSTDate(); // KST Í∏∞Ï§Ä Ïò§Îäò ÎÇ†Ïßú
    
    if (date < today || !isDateAvailable(date)) return;

    if (!selectedDates.checkIn || selectingCheckOut) {
      if (!selectedDates.checkIn) {
        setSelectedDates({ checkIn: date, checkOut: null });
        setSelectingCheckOut(true);
      } else {
        if (date <= selectedDates.checkIn) {
          setSelectedDates({ checkIn: date, checkOut: null });
        } else {
          // Ï≤¥ÌÅ¨Ïù∏Í≥º Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏÇ¨Ïù¥Ïóê ÏòàÏïΩ Î∂àÍ∞ÄÎä•Ìïú ÎÇ†ÏßúÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
          let canBook = true;
          const checkDate = new Date(selectedDates.checkIn);
          checkDate.setDate(checkDate.getDate() + 1);
          
          while (checkDate <= date) {
            if (!isDateAvailable(checkDate)) {
              canBook = false;
              break;
            }
            checkDate.setDate(checkDate.getDate() + 1);
          }
          
          if (canBook) {
            setSelectedDates({ ...selectedDates, checkOut: date });
            setSelectingCheckOut(false);
          } else {
            setSelectedDates({ checkIn: date, checkOut: null });
            setSelectingCheckOut(true);
          }
        }
      }
    } else {
      setSelectedDates({ checkIn: date, checkOut: null });
      setSelectingCheckOut(true);
    }
  };

  const handleNextMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
  };

  const handlePrevMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
  };

  const canProceedToBooking = () => {
    return selectedDates.checkIn && selectedDates.checkOut;
  };

  // KST Í∏∞Ï§Ä ÏàôÎ∞ï ÏùºÏàò Í≥ÑÏÇ∞ Ìï®Ïàò
  const calculateStayDays = (): number => {
    if (!selectedDates.checkIn || !selectedDates.checkOut) return 0;
    
    const timeDifference = selectedDates.checkOut.getTime() - selectedDates.checkIn.getTime();
    const daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
    
    return daysDifference;
  };

  // ÏòàÏïΩÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ (KST Í∏∞Ï§Ä 6Ïùº Ïù¥ÏÉÅ Ï≤¥ÌÅ¨)
  const handleBookingButtonClick = () => {
    if (!canProceedToBooking()) {
      alert('Please select both check-in and check-out dates.');
      return;
    }
    
    const stayDays = calculateStayDays(); // KST Í∏∞Ï§ÄÏúºÎ°ú Í≥ÑÏÇ∞
    console.log('Stay days (KST basis):', stayDays);
    
    // 6Ïùº Ïù¥ÏÉÅ ÏòàÏïΩ Ï†úÌïú Ï≤¥ÌÅ¨ (KST Í∏∞Ï§Ä)
    if (stayDays >= 6) {
      console.log('6+ days booking - showing warning modal');
      setShowWarningModal(true);
      return;
    }
    
    // 5Î∞ï Ïù¥ÌïòÏù∏ Í≤ΩÏö∞ Îã§Ïùå Îã®Í≥ÑÎ°ú
    console.log('5 nights or less - proceeding to next step');
    setStep(3);
  };

  const handleBookingSubmit = async () => {
    if (!selectedRoom || !selectedDates.checkIn || !selectedDates.checkOut || !bookingForm.guestName || !bookingForm.phoneNumber) {
      alert('Please fill in all required information.');
      return;
    }
    
    const totalGuests = 2 + bookingForm.additionalGuests;
    
    if (totalGuests > 4) {
      alert(`Maximum occupancy is 4 guests per room.`);
      return;
    }

    try {
      // KST ÎÇ†ÏßúÎ•º UTC ÌòïÏãùÏúºÎ°ú Î≥ÄÌôòÌïòÏó¨ FirebaseÏóê Ï†ÄÏû•
      const newReservation = {
        customer_name: bookingForm.guestName,
        phone_number: bookingForm.phoneNumber,
        room_id: selectedRoom.originalId || 1,
        check_in_date: formatDateForServer(selectedDates.checkIn), // UTCÎ°ú Î≥ÄÌôò
        check_out_date: formatDateForServer(selectedDates.checkOut), // UTCÎ°ú Î≥ÄÌôò
        number_of_guests: totalGuests,
        total_price: calculateTotalPrice(),
        created_at: new Date().toISOString() // ÏÉùÏÑ± ÏãúÍ∞Ñ Ï∂îÍ∞Ä
      };

      console.log('üî• FirebaseÏóê ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï§ë (UTC format):', newReservation);

      // FirebaseÏóê ÏòàÏïΩ Ï†ÄÏû•
      const savedReservation = await addReservation(newReservation);
      console.log('‚úÖ ÏòàÏïΩ Ï†ÄÏû• ÏôÑÎ£å:', savedReservation);

      // ÏòàÏïΩ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
      setReservations(prev => [...prev, savedReservation]);

      setShowCompleteModal(true);
      // 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Î™®Îã¨ Îã´Í≥† Ï¥àÍ∏∞Ìôî
      setTimeout(() => {
        setShowCompleteModal(false);
        // Ï¥àÍ∏∞Ìôî
        setStep(1);
        setSelectedRoom(null);
        setSelectedDates({ checkIn: null, checkOut: null });
        setBookingForm({ additionalGuests: 0, guestName: '', phoneNumber: '' });
        setSelectingCheckOut(false);
      }, 3000);

    } catch (error) {
      console.error('‚ùå ÏòàÏïΩ Ï†ÄÏû• Ïã§Ìå®:', error);
      alert('ÏòàÏïΩ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
    }
  };

  // Í≤ΩÍ≥† Î™®Îã¨ ÌôïÏù∏ Î≤ÑÌäº Ìï∏Îì§Îü¨
  const handleWarningModalConfirm = () => {
    console.log('Warning modal confirm button clicked');
    setShowWarningModal(false);
    // Ï≤¥ÌÅ¨ÏïÑÏõÉ ÎÇ†Ïßú Ï¥àÍ∏∞ÌôîÌïòÍ≥† Îã§Ïãú ÏÑ†ÌÉùÌïòÎèÑÎ°ù Ìï®
    setSelectedDates(prev => ({ ...prev, checkOut: null }));
    setSelectingCheckOut(true);
  };

  if (loading) {
    return (
      <div className="realtime-booking-page">
        <div className="loading">üî• Loading data from Firebase...</div>
      </div>
    );
  }

  // 1Îã®Í≥Ñ: Í∞ùÏã§ ÏÑ†ÌÉù ÌôîÎ©¥
  if (step === 1) {
    return (
      <div className="realtime-booking-page">
        <section className="booking-hero">
          <div className="hero-overlay">
            <h1>RESERVATION</h1>
            <div className="divider"></div>
            <p>Real-time Booking</p>
          </div>
        </section>

        <section className="room-selection-section">
          <div className="container">
            <h2>Select Room</h2>
            
            <div className="rooms-grid">
              {rooms.map((room, index) => (
                <div 
                  key={room.id} 
                  className={`room-card2 room-type-${index + 1}`}
                  onClick={() => handleRoomSelect(room)}
                >
                  <div className="room-image">
                    <div className="room-overlay">
                      <h3>{room.name_eng.toUpperCase()}</h3>
                      <div className="arrow">‚Üí</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="booking-info">
              <h3>Cancellation & Refund Policy</h3>
              <ul>
                <li>Cancellation is available without charge until 6:00 PM one day before the reservation date.</li>
                <li>After 6:00 PM one day before / same day / no-show: 100% of room rate + cancellation fee will be charged.</li>
                <li>- Peak season: 80% of the first day's room rate will be charged as penalty.</li>
                <li>- Off-peak season (excluding peak season): 10% of the first day's room rate will be charged as penalty.</li>
                <li>Some packages may have separate cancellation policies.</li>
              </ul>
            </div>
          </div>
        </section>

        {/* Data Reset Modal - Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã Î™®Îã¨ */}
        {showResetModal && (
          <div className="modal-overlay">
            <div className="reset-modal">
              <h3>Ï§ëÎ≥µÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§</h3>
              <p>Firebase Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï§ëÎ≥µ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏäµÎãàÎã§. Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
              <div className="modal-actions">
                <button 
                  className="modal-cancel-btn" 
                  onClick={() => setShowResetModal(false)}
                >
                  Ï∑®ÏÜå
                </button>
                <button 
                  className="modal-confirm-btn" 
                  onClick={handleDataReset}
                >
                  Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // 2Îã®Í≥ÑÏôÄ 3Îã®Í≥ÑÎäî Í∏∞Ï°¥ ÏΩîÎìúÏôÄ ÎèôÏùºÌïòÎØÄÎ°ú ÏÉùÎûµ...
  // ÎÇòÎ®∏ÏßÄ Î†åÎçîÎßÅ Î°úÏßÅÏùÄ Í∏∞Ï°¥Í≥º ÎèôÏùºÌï©ÎãàÎã§.

  // 2Îã®Í≥Ñ: ÎÇ†Ïßú ÏÑ†ÌÉù ÌôîÎ©¥
  if (step === 2) {
    const days = getDaysInMonth(currentMonth);
    const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const today = getKSTDate(); // KST Í∏∞Ï§Ä Ïò§Îäò ÎÇ†Ïßú

    return (
      <div className="realtime-booking-page">
        <section className="booking-hero">
          <div className="hero-overlay">
            <h1>RESERVATION</h1>
            <div className="divider"></div>
            <p>Real-time Booking</p>
          </div>
        </section>
        
        <section className="calendar-section">
          <div className="container">
            <div className="calendar-layout">
              <div className="room-info-side">
                <div className="selected-room-card2">
                  <h3>{selectedRoom?.name_eng.toUpperCase()}</h3>
                  <div className="room-image-small">
                    <img src={selectedRoom ? getRoomImageUrl(selectedRoom) : ''} alt={selectedRoom?.name} />
                  </div>
                  <p className="room-description">{selectedRoom?.desc}</p>
                  <div className="room-price">
                    <span className="price-label">Base rate per night</span>
                    <span className="price">{selectedDates.checkIn ? calculateDatePrice(selectedDates.checkIn, selectedRoom.originalId || 1).toLocaleString() : getBaseRoomPrice(selectedRoom.originalId || 1).toLocaleString()} KRW</span>
                  </div>
                </div>
                
                <div className="guest-selection">
                  <h4>Additional Guests</h4>
                  <div className="guest-input">
                    <button 
                      className="guest-btn"
                      onClick={() => setBookingForm(prev => ({ ...prev, additionalGuests: Math.max(0, prev.additionalGuests - 1) }))}
                    >
                      -
                    </button>
                    <span className="guest-count">{bookingForm.additionalGuests}</span>
                    <button 
                      className="guest-btn"
                      onClick={() => setBookingForm(prev => ({ ...prev, additionalGuests: Math.min(2, prev.additionalGuests + 1) }))}
                    >
                      +
                    </button>
                  </div>
                  <p className="capacity-info">Base 2 guests + additional guests (max 4)</p>
                  {bookingForm.additionalGuests > 0 && (
                    <p className="additional-cost-info">20% additional charge per extra guest</p>
                  )}
                </div>

                <div className="total-price">
                  <h4>Total Amount</h4>
                  <span className="total-amount">{calculateTotalPrice().toLocaleString()} KRW</span>
                  {selectedDates.checkIn && selectedDates.checkOut && (
                    <p className="nights-info">
                      {calculateStayDays()} nights {calculateStayDays() + 1} days
                    </p>
                  )}
                </div>

                <button 
                  className="back-btn"
                  onClick={() => setStep(1)}
                >
                  Back
                </button>
              </div>

              <div className="calendar-main">
                <div className="calendar-header">
                  <button className="nav-btn" onClick={handlePrevMonth}>‚Äπ</button>
                  <h3>{formatDate(currentMonth)}</h3>
                  <button className="nav-btn" onClick={handleNextMonth}>‚Ä∫</button>
                </div>

                <div className="calendar-grid">
                  <div className="weekdays">
                    {weekDays.map(day => (
                      <div key={day} className="weekday">{day}</div>
                    ))}
                  </div>
                  
                  <div className="days-grid">
                    {days.map((date, index) => {
                      const isCurrentMonth = date.getMonth() === currentMonth.getMonth();
                      const isPast = date < today;
                      const isCheckIn = selectedDates.checkIn && isSameDay(date, selectedDates.checkIn);
                      const isCheckOut = selectedDates.checkOut && isSameDay(date, selectedDates.checkOut);
                      const isInRange = isDateInRange(date);
                      const isUnavailable = !isDateAvailable(date) && isCurrentMonth && !isPast;
                      const isHoliday = holidays.some(holiday => holiday.holiday_date === formatKSTDate(date));
                      const isSunday = date.getDay() === 0;
                      
                      return (
                        <div
                          key={index}
                          className={`calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isPast ? 'past' : ''} ${isCheckIn ? 'check-in' : ''} ${isCheckOut ? 'check-out' : ''} ${isInRange ? 'in-range' : ''} ${isUnavailable ? 'unavailable' : ''} ${isHoliday ? 'holiday' : ''} ${isSunday ? 'sunday' : ''}`}
                          onClick={() => isCurrentMonth && !isPast && !isUnavailable && handleDateClick(date)}
                        >
                          <span className="day-number">{date.getDate()}</span>
                          {isCheckIn && <span className="check-label">Check-in</span>}
                          {isCheckOut && <span className="check-label">Check-out</span>}
                          {isUnavailable && <span className="unavailable-label">Unavailable</span>}
                          {isHoliday && isCurrentMonth && <span className="holiday-dot"></span>}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Calendar Legend */}
                <div className="calendar-legend">
                  <div className="legend-item">
                    <span className="legend-dot holiday-legend"></span>
                    <span className="legend-text">Holiday</span>
                  </div>
                  <div className="legend-item">
                    <span className="legend-dot unavailable-legend"></span>
                    <span className="legend-text">Unavailable</span>
                  </div>
                </div>

                <div className="booking-actions">
                  <button 
                    className={`next-btn ${canProceedToBooking() ? 'active' : ''}`}
                    onClick={handleBookingButtonClick}
                    disabled={!canProceedToBooking()}
                  >
                    Make Reservation
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* Warning Modal - 6Ïùº Ïù¥ÏÉÅ ÏòàÏïΩ Í≤ΩÍ≥† */}
        {showWarningModal && (
          <div className="modal-overlay">
            <div className="warning-modal">
              <h3>You cannot book for 7 or more days.</h3>
              <button 
                className="modal-confirm-btn" 
                onClick={handleWarningModalConfirm}
              >
                Confirm
              </button>
            </div>
          </div>
        )}
      </div>
    );
  }

  // 3Îã®Í≥Ñ: ÏòàÏïΩ Ìèº ÌôîÎ©¥
  return (
    <div className="realtime-booking-page">
      <section className="booking-hero">
        <div className="hero-overlay">
          <h1>RESERVATION</h1>
          <div className="divider"></div>
          <p>Real-time Booking</p>
        </div>
      </section>
      
      <section className="booking-form-section">
        <div className="container">
          <div className="form-layout">
            <div className="form-main">
              <h2>Booking Registration</h2>
              
              <div className="form-grid">
                <div className="form-group">
                  <label>ROOM</label>
                  <div className="form-value">{selectedRoom?.name_eng.toUpperCase()}</div>
                </div>

                <div className="form-group">
                  <label>Additional Guests</label>
                  <div className="form-value">{bookingForm.additionalGuests} guests (Base 2 + {bookingForm.additionalGuests} additional)</div>
                </div>

                <div className="form-group">
                  <label>Guest Name</label>
                  <input
                    type="text"
                    placeholder="Please enter the guest name"
                    value={bookingForm.guestName}
                    onChange={(e) => setBookingForm(prev => ({ ...prev, guestName: e.target.value }))}
                    className={!bookingForm.guestName ? 'error' : ''}
                  />
                  {!bookingForm.guestName && <span className="error-text">This field is required.</span>}
                </div>

                <div className="form-group">
                  <label>Phone Number</label>
                  <input
                    type="tel"
                    placeholder="Please enter your phone number"
                    value={bookingForm.phoneNumber}
                    onChange={(e) => setBookingForm(prev => ({ ...prev, phoneNumber: e.target.value }))}
                    className={!bookingForm.phoneNumber ? 'error' : ''}
                  />
                  {!bookingForm.phoneNumber && <span className="error-text">This field is required.</span>}
                </div>

                <div className="form-group full-width">
                  <label>Total Amount</label>
                  <div className="total-price-display">
                    {calculateTotalPrice().toLocaleString()} KRW
                    {selectedDates.checkIn && selectedDates.checkOut && (
                      <span className="nights-detail">
                        ({calculateStayDays()} nights {calculateStayDays() + 1} days)
                      </span>
                    )}
                  </div>
                </div>
              </div>

              <div className="form-actions">
                <button className="back-btn" onClick={() => setStep(2)}>Back</button>
                <button className="submit-btn" onClick={handleBookingSubmit}>Submit Reservation</button>
              </div>
            </div>

            <div className="calendar-sidebar">
              <div className="calendar-header">
                <button className="nav-btn" onClick={handlePrevMonth}>‚Äπ</button>
                <h3>{formatDate(currentMonth)}</h3>
                <button className="nav-btn" onClick={handleNextMonth}>‚Ä∫</button>
              </div>

              <div className="calendar-grid-small">
                <div className="weekdays-small">
                  {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                    <div key={day} className="weekday-small">{day}</div>
                  ))}
                </div>
                
                <div className="days-grid-small">
                  {getDaysInMonth(currentMonth).map((date, index) => {
                    const isCurrentMonth = date.getMonth() === currentMonth.getMonth();
                    const isCheckIn = selectedDates.checkIn && isSameDay(date, selectedDates.checkIn);
                    const isCheckOut = selectedDates.checkOut && isSameDay(date, selectedDates.checkOut);
                    const isInRange = isDateInRange(date);
                    
                    return (
                      <div
                        key={index}
                        className={`calendar-day-small ${!isCurrentMonth ? 'other-month' : ''} ${isCheckIn || isCheckOut ? 'selected' : ''} ${isInRange ? 'in-range' : ''}`}
                      >
                        {date.getDate()}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Complete Modal - ÏòàÏïΩ ÏôÑÎ£å */}
      {showCompleteModal && (
        <div className="modal-overlay">
          <div className="complete-modal">
            <h3>Your reservation has been completed.</h3>
            <button className="modal-confirm-btn" onClick={() => setShowCompleteModal(false)}>
              Confirm
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default RealtimeBooking;